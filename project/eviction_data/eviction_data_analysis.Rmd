---
title: "final_project.rmd"
author: "Taylor Nichols"
date: "2025-04-24"
output: html_document
---

Problems I am having so far:
I am not really sure what to do with this data. I know how to compare it head to head but I am not sure what statistical analysis needs to happen here. I also need to load in the ownership data -- it's stored as .ods so I need to figure out how to load that in and get it cleaned and put into a format that I can use to compare it with eviction/violations data. ALSO my evictions data is insanely messy. 

ALSO I need to figure out how i am going to identify owners that have different LLC names but are the same company. That might honestly take too much work, but some will just be data cleaning or matching obvious names. I think I need to sit down and think about this a bit/play with that data. 

Evictions data comes from the DC Office of the Tenant Advocate. The violations data came from the DC Dept of Buildings Violations and Abatement Tool. https://dataviz1.dc.gov/t/OCTO/views/DOBPublicDashboard/ViolationsAbatementLVT?%3AshowAppBanner=false&%3Adisplay_count=n&%3AshowVizHome=n&%3Aorigin=viz_share_link&%3Aembed=yes&%3Atoolbar=no

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate)
library(janitor)
```

```{r}
eviction_data <- read_csv("eviction_data_ward_geocodio.csv")
df_violations <- read_delim("detailed_landlord_violations.csv", 
                           delim = "\t",  # Try tab as delimiter
                           locale = locale(encoding = "UTF-16LE"),
                           show_col_types = FALSE) |> clean_names() |>
                            mutate(created_date = case_when(str_detect(created_date, "^\\d{1,2}/\\d{1,2}/\\d{4}$") ~ mdy(created_date)))

```
Let's look at our eviction data 
```{r}
eviction_data
```
Our eviction data is pretty messy. It spans from Nov 2023 to June 2025. It includes address, case number, eviction date, and other geocoding info. 

Now let's look at our violations data:
```{r}
df_violations
```

This data spans from march 2018 to march 2025. We also have owner, violation address, unit, cap_id (not sure what this is), floor, location, violation and fine amt.

I think we can assume that addresses with units are likely owned by the same owner (unless they're condos -- maybe this isn't a safe assumption, actually.) Our landlord data is stored with unit as a separate column, so let's make our data format match.

```{r}
eviction_data_clean <- eviction_data |>
  select(case_number, defendant_address, quad, zipcode, eviction_date, full_address, lat, lng, ward, year, month_name)
```

```{r}
eviction_data_clean <- eviction_data_clean %>%
  mutate(
    # First, separate the unit information from the base address
    base_address = case_when(
      # Extract everything before UNIT, APT, etc.
      str_detect(defendant_address, "(?i)\\s+(UNIT|APT|APARTMENT|SUITE|STE)\\s+[A-Z0-9-]+") ~
        str_trim(str_replace(defendant_address, 
                           "(?i)\\s+(UNIT|APT|APARTMENT|SUITE|STE)\\s+[A-Z0-9-]+.*$", "")),
      
      # If no UNIT/APT keyword, extract everything before a comma or #
      str_detect(defendant_address, "[,#]") ~
        str_trim(str_replace(str_extract(defendant_address, "^[^,#]+"), "\\s+$", "")),
      
      # Default: use the whole address if no unit information is found
      TRUE ~ defendant_address
    ),
    
    # Extract unit information
    unit_info = case_when(
      # Match "UNIT 123" format (works for UNIT 202, UNIT 409, UNIT 101, etc.)
      str_detect(defendant_address, "(?i)\\s+UNIT\\s+\\d+") ~
        str_trim(str_extract(defendant_address, "(?i)\\s+UNIT\\s+\\d+")),
      
      # Match "APT 123" format
      str_detect(defendant_address, "(?i)\\s+APT(ARTMENT)?\\s+\\d+") ~
        str_trim(str_extract(defendant_address, "(?i)\\s+APT(ARTMENT)?\\s+\\d+")),
      
      # Match "STE 123" format
      str_detect(defendant_address, "(?i)\\s+S(UI)?TE\\s+\\d+") ~
        str_trim(str_extract(defendant_address, "(?i)\\s+S(UI)?TE\\s+\\d+")),
      
      # Match "#123" format
      str_detect(defendant_address, "#\\s*[A-Z0-9-]+") ~
        str_trim(str_extract(defendant_address, "#\\s*[A-Z0-9-]+")),
      
      # Match comma followed by unit information
      str_detect(defendant_address, ",\\s*(?i)(UNIT|APT|APARTMENT|SUITE|STE)\\s+\\d+") ~
        str_trim(str_extract(defendant_address, "(?i)(UNIT|APT|APARTMENT|SUITE|STE)\\s+\\d+")),
      
      # Default: NA if no unit information is found
      TRUE ~ NA_character_
    ),
    
    # Extract just the unit number (without the UNIT/APT prefix)
    clean_unit = case_when(
      !is.na(unit_info) & str_detect(unit_info, "(?i)(UNIT|APT|APARTMENT|SUITE|STE)\\s+\\d+") ~
        str_trim(str_replace(unit_info, "(?i)(UNIT|APT|APARTMENT|SUITE|STE)\\s+", "")),
      
      !is.na(unit_info) & str_detect(unit_info, "#\\s*\\d+") ~
        str_trim(str_replace(unit_info, "#\\s*", "")),
      
      TRUE ~ NA_character_
    )
  ) %>%
  # Now clean and standardize the base address
  mutate(
    clean_address = str_replace_all(base_address, "[,\\.]+", ""),
    
    # Standardize street suffixes
    clean_address = case_when(
      str_detect(clean_address, "(?i)\\s+STREET(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+STREET(\\s+|$)", " ST "),
      str_detect(clean_address, "(?i)\\s+AVENUE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+AVENUE(\\s+|$)", " AVE "),
      str_detect(clean_address, "(?i)\\s+CIRCLE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+CIRCLE(\\s+|$)", " CIR "),
      str_detect(clean_address, "(?i)\\s+BOULEVARD(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+BOULEVARD(\\s+|$)", " BLVD "),
      str_detect(clean_address, "(?i)\\s+COURT(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+COURT(\\s+|$)", " CT "),
      str_detect(clean_address, "(?i)\\s+DRIVE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+DRIVE(\\s+|$)", " DR "),
      str_detect(clean_address, "(?i)\\s+LANE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+LANE(\\s+|$)", " LN "),
      str_detect(clean_address, "(?i)\\s+ROAD(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+ROAD(\\s+|$)", " RD "),
      str_detect(clean_address, "(?i)\\s+PLACE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+PLACE(\\s+|$)", " PL "),
      str_detect(clean_address, "(?i)\\s+TERRACE(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+TERRACE(\\s+|$)", " TER "),
      str_detect(clean_address, "(?i)\\s+HIGHWAY(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+HIGHWAY(\\s+|$)", " HWY "),
      str_detect(clean_address, "(?i)\\s+PARKWAY(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+PARKWAY(\\s+|$)", " PKWY "),
      str_detect(clean_address, "(?i)\\s+WAY(\\s+|$)") ~ 
        str_replace_all(clean_address, "(?i)\\s+WAY(\\s+|$)", " WY "),
        
      # Default: keep the address as is
      TRUE ~ clean_address
    ),
    
    # Clean up any extra spaces
    clean_address = str_trim(str_replace_all(clean_address, "\\s+", " "))
  )
```

The evictions data is still pretty messy - units will need more cleaning, but at least we can play around with base address now.

```{r}
df_violations_clean <- df_violations |>
  select(s_no, owner, violation_address, unit, created_date, location, violation)
```

Let's make a df that shows us how many violations have happened at each street address and how many units there are. 

```{r}
# Count total violations and unique units per address
df_violations_summary <- df_violations_clean |>
  group_by(violation_address) |>
  summarise(
    total_violations = n(),
    unique_violation_units = n_distinct(unit, na.rm = TRUE),
    unit_violation_list = paste(unique(na.omit(unit)), collapse = ", ")
  )
```

Let's see how many violations there are per owner for fun.
```{r}
df_violations_clean |>
  group_by(owner) |>
  summarise(count=n()) |>
  arrange(desc(count))
```
Now, let's join our violations to our evictions data.
tabling this for now because i need to do some more data cleaning to do it.



```{r}
evictions_summary <- eviction_data_clean |>
  # First combine clean_address and quad (only where quad exists)
  mutate(full_address = ifelse(
    !is.na(quad),
    paste(clean_address, quad),
    clean_address
  )) |>
  # Then continue with your grouping and summarizing
  group_by(full_address) |>
  summarise(
    total_evictions = n(),
    unique_eviction_units = n_distinct(clean_unit, na.rm = TRUE),
    eviction_unit_list = toString(na.omit(unique(clean_unit)))
  )

# Rename the address column in violations summary to match your naming convention
df_violations_summary <- df_violations_summary |>
  rename(full_address = violation_address)
```


```{r}
summary_df <- full_join(df_violations_summary, evictions_summary, by = c("full_address"))
```

